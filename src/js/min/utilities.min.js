/*
Author:     Niklas Heer, Chris Wiegman
Project:    Better Google Tasks
License:    GPL v3
Build date: 06.04.2014 
*/
(function(){window.getManifest=function(a){var b;b=new XMLHttpRequest,b.onload=function(){a(JSON.parse(b.responseText))},b.open("GET","/manifest.json",!0),b.send(null)},window.updateData=function(){var a,b,c,d,e,f,g,h,i,j,k;d=localStorage.getItem("com.bit51.chrome.bettergoogletasks.default_count")||TASKS_COUNT,c=localStorage.getItem("com.bit51.chrome.bettergoogletasks.countinterval")||TASKS_COUNTINTERVAL,b=localStorage.getItem("com.bit51.chrome.bettergoogletasks.count_list")||TASKS_LIST,e=localStorage.getItem("com.bit51.chrome.bettergoogletasks.default_list")||TASKS_DEFAULT_LIST,j=6e4*c,a=0,h=0,i=0,g=null,f=null,chrome.browserAction.setBadgeBackgroundColor({color:[200,200,200,153]}),chrome.browserAction.setBadgeText({text:"..."}),chrome.browserAction.setTitle({title:"Loading Google Tasks"}),k=new XMLHttpRequest,k.onreadystatechange=function(){var a,c,d,h,i,j,l,m,n,o,p;if(4===k.readyState&&200===k.status){if(f=new Array,i=k.responseText,-1!==i.indexOf('<form method="GET" action="https://mail.google.com/tasks/m">'))for(n=void 0,p=void 0,o=void 0,d=void 0,h=void 0,j=void 0,o=i,p=i.length,n=i.indexOf("<option value="),j=0;p>0&&n>-1;)if(o=o.substr(n+15,p),p=o.length,d=o.substr(0,o.indexOf('"')),o=o.substr(o.indexOf(">")+1,p),h=o.substr(0,o.indexOf("</option>")),p=o.length,n=o.indexOf("<option value="),"def"===b&&d===e||"all"===b){if(f.length>0)for(l=0;l<f.length;)f[l].id===d&&(d=-1),l++;else f[j]={id:d,title:h};-1!==d&&(f[j]={id:d,title:h}),j++}if(null!==f&&f.length>0){for(c=function(){m===f.length?(updateBadge(),getNotifications()):(chrome.extension.getBackgroundPage(),window.setTimeout(function(){c()},1e3))},g=new Array,m=0,l=0;l<f.length;)getTasks(f[l]),l++;c()}}else 4===k.readyState&&200!==k.status&&(chrome.browserAction.setBadgeBackgroundColor({color:[200,200,200,153]}),chrome.browserAction.setBadgeText({text:"X"}),chrome.browserAction.setTitle({title:"Better Google Tasks - Not Logged In"}),a="https://mail.google.com/tasks/m",window.setTimeout(function(){dataError()},5e3))},k.open("GET","https://mail.google.com/tasks/m?pli=1&cache="+Math.random(),!0),k.timeout=5e3,k.send(null),window.setTimeout(function(){updateData()},j)},window.dataError=function(){var a;a=document.createElement("iframe"),a.setAttribute("src",address),a.setAttribute("id","tasksPage"),$("#tasksPage").replaceWith(a),updateData()},window.getTasks=function(a){var b,c,d;b=localStorage.getItem("com.bit51.chrome.bettergoogletasks.default_count")||TASKS_COUNT,c=todaysDate(),d=new XMLHttpRequest,d.onreadystatechange=function(){var a,e;4===d.readyState&&200===d.status&&(e=d.responseText,e.match(/_setup\((.*)\)\}/)&&(a=JSON.parse(RegExp.$1),$.each(a.t.tasks,function(a,d){(d.name.length>0||d.notes&&d.notes.length>0||d.task_date&&d.task_date.length>0)&&d.completed===!1&&(tasks.push(d),("all"===b||"today"===b&&d.task_date===c||"past"===b&&parseInt(d.task_date)<parseInt(c)||"presentpast"===b&&parseInt(d.task_date)<=parseInt(c)||"alldates"===b&&"undefined"!=typeof d.task_date)&&badgeCount++,parseInt(d.task_date)<parseInt(c)&&tasksOverdue++,parseInt(d.task_date)===parseInt(c)&&tasksDueToday++)})),listCount++)},d.open("GET","https://mail.google.com/tasks/ig?listid="+a.id,!0),d.timeout=5e3,d.send(null)},window.updateBadge=function(){var a,b;a=localStorage.getItem("com.bit51.chrome.bettergoogletasks.default_count")||TASKS_COUNT,"none"!==a?null===taskLists?(chrome.browserAction.setBadgeBackgroundColor({color:[200,200,200,153]}),chrome.browserAction.setBadgeText({text:"X"}),chrome.browserAction.setTitle({title:"Better Google Tasks - Not Logged In"}),window.setTimeout(function(){updateTasks()},1e4)):badgeCount>0?(chrome.browserAction.setBadgeBackgroundColor({color:[153,0,0,153]}),chrome.browserAction.setBadgeText({text:badgeCount.toString()}),chrome.browserAction.setTitle({title:TASKS_TITLE+badgeCount.toString()})):(b=localStorage.getItem("com.bit51.chrome.bettergoogletasks.hide_zero")||TASKS_ZERO,chrome.browserAction.setBadgeBackgroundColor({color:[0,0,255,153]}),chrome.browserAction.setTitle({title:"Google Tasks"}),chrome.browserAction.setBadgeText("0"===b?{text:"0"}:{text:""})):(chrome.browserAction.setBadgeText({text:""}),chrome.browserAction.setTitle({title:"Google Tasks"}))},window.getNotifications=function(){var a,b,c,d,e,f,g,h,i;c=localStorage.getItem("com.bit51.chrome.bettergoogletasks.last_notify")||0,c<(new Date).getTime()-432e5&&(e=localStorage.getItem("com.bit51.chrome.bettergoogletasks.notify")||TASKS_NOTIFY,localStorage.setItem("com.bit51.chrome.bettergoogletasks.last_notify",(new Date).getTime()),e>0&&(i=void 0,h=void 0,(tasksDueToday>0||tasksOverdue>0)&&(tasksDueToday>0&&tasksOverdue>0?(tasksDueToday>1?(b="Tasks",a="tasks"):(b="Task",a="task"),tasksOverdue>1?(g="Tasks",f="tasks"):(g="Task",f="task"),i="Overdue "+g+" and "+b+" Due Today",h="You have "+tasksOverdue+" overdue "+f+" & "+tasksDueToday+" "+a+" due today."):tasksDueToday>0?(tasksDueToday>1?(b="Tasks",a="tasks"):(b="Task",a="task"),i=b+" Due Today",h="You have "+tasksDueToday+" "+a+" due today."):(tasksOverdue>1?(g="Tasks",f="tasks"):(g="Task",f="task"),i="Overdue "+g,h="You have "+tasksOverdue+" overdue "+f+".")),d={type:"basic",title:i,message:h,iconUrl:"/images/icon.png"},chrome.notifications.create("BGT",d,function(){})))},window.todaysDate=function(){var a,b,c,d;return c=new Date,d=c.getYear(),b=c.getMonth()+1,a=c.getDate(),2e3>d&&(d+=1900),10>b&&(b="0"+b),10>a&&(a="0"+a),d.toString()+b.toString()+a.toString()},window.inOpen=function(){var a;a=chrome.extension.getViews({type:"popup"}),a.length>0?window.setTimeout(function(){inOpen()},5e3):updateData()},window.taskLists=null,window.tasks=null,window.badgeCount=0,window.tasksDueToday=0,window.tasksOverdue=0,window.listCount=0}).call(this);