/*
Author:     Niklas Heer, Chris Wiegman
Project:    Better Google Tasks
License:    GPL v3
Build date: 06.04.2014 
*/
(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n;c=function(a){var b;b=new XMLHttpRequest,b.onload=function(){a(JSON.parse(b.responseText))},b.open("GET","/manifest.json",!0),b.send(null)},n=function(){var a,c,f,g,h,i,j,k,l,o,p;g=localStorage.getItem("com.bit51.chrome.bettergoogletasks.default_count")||TASKS_COUNT,f=localStorage.getItem("com.bit51.chrome.bettergoogletasks.countinterval")||TASKS_COUNTINTERVAL,c=localStorage.getItem("com.bit51.chrome.bettergoogletasks.count_list")||TASKS_LIST,h=localStorage.getItem("com.bit51.chrome.bettergoogletasks.default_list")||TASKS_DEFAULT_LIST,o=6e4*f,a=0,k=0,l=0,j=null,i=null,chrome.browserAction.setBadgeBackgroundColor({color:[200,200,200,153]}),chrome.browserAction.setBadgeText({text:"..."}),chrome.browserAction.setTitle({title:"Loading Google Tasks"}),p=new XMLHttpRequest,p.onreadystatechange=function(){var a,f,g,k,l,n,o,q,r,s,t;if(4===p.readyState&&200===p.status){if(i=new Array,l=p.responseText,-1!==l.indexOf('<form method="GET" action="https://mail.google.com/tasks/m">'))for(r=void 0,t=void 0,s=void 0,g=void 0,k=void 0,n=void 0,s=l,t=l.length,r=l.indexOf("<option value="),n=0;t>0&&r>-1;)if(s=s.substr(r+15,t),t=s.length,g=s.substr(0,s.indexOf('"')),s=s.substr(s.indexOf(">")+1,t),k=s.substr(0,s.indexOf("</option>")),t=s.length,r=s.indexOf("<option value="),"def"===c&&g===h||"all"===c){if(i.length>0)for(o=0;o<i.length;)i[o].id===g&&(g=-1),o++;else i[n]={id:g,title:k};-1!==g&&(i[n]={id:g,title:k}),n++}if(null!==i&&i.length>0){for(f=function(){q===i.length?(m(),d()):(chrome.extension.getBackgroundPage(),window.setTimeout(function(){f()},1e3))},j=new Array,q=0,o=0;o<i.length;)e(i[o]),o++;f()}}else 4===p.readyState&&200!==p.status&&(chrome.browserAction.setBadgeBackgroundColor({color:[200,200,200,153]}),chrome.browserAction.setBadgeText({text:"X"}),chrome.browserAction.setTitle({title:"Better Google Tasks - Not Logged In"}),a="https://mail.google.com/tasks/m",window.setTimeout(function(){b()},5e3))},p.open("GET","https://mail.google.com/tasks/m?pli=1&cache="+Math.random(),!0),p.timeout=5e3,p.send(null),window.setTimeout(function(){n()},o)},b=function(){var a;a=document.createElement("iframe"),a.setAttribute("src",address),a.setAttribute("id","tasksPage"),$("#tasksPage").replaceWith(a),n()},e=function(b){var c,d,e;c=localStorage.getItem("com.bit51.chrome.bettergoogletasks.default_count")||TASKS_COUNT,d=l(),e=new XMLHttpRequest,e.onreadystatechange=function(){var b,f;4===e.readyState&&200===e.status&&(f=e.responseText,f.match(/_setup\((.*)\)\}/)&&(b=JSON.parse(RegExp.$1),$.each(b.t.tasks,function(b,e){(e.name.length>0||e.notes&&e.notes.length>0||e.task_date&&e.task_date.length>0)&&e.completed===!1&&(i.push(e),("all"===c||"today"===c&&e.task_date===d||"past"===c&&parseInt(e.task_date)<parseInt(d)||"presentpast"===c&&parseInt(e.task_date)<=parseInt(d)||"alldates"===c&&"undefined"!=typeof e.task_date)&&a++,parseInt(e.task_date)<parseInt(d)&&k++,parseInt(e.task_date)===parseInt(d)&&j++)})),g++)},e.open("GET","https://mail.google.com/tasks/ig?listid="+b.id,!0),e.timeout=5e3,e.send(null)},m=function(){var b,c;b=localStorage.getItem("com.bit51.chrome.bettergoogletasks.default_count")||TASKS_COUNT,"none"!==b?null===h?(chrome.browserAction.setBadgeBackgroundColor({color:[200,200,200,153]}),chrome.browserAction.setBadgeText({text:"X"}),chrome.browserAction.setTitle({title:"Better Google Tasks - Not Logged In"}),window.setTimeout(function(){updateTasks()},1e4)):a>0?(chrome.browserAction.setBadgeBackgroundColor({color:[153,0,0,153]}),chrome.browserAction.setBadgeText({text:a.toString()}),chrome.browserAction.setTitle({title:TASKS_TITLE+a.toString()})):(c=localStorage.getItem("com.bit51.chrome.bettergoogletasks.hide_zero")||TASKS_ZERO,chrome.browserAction.setBadgeBackgroundColor({color:[0,0,255,153]}),chrome.browserAction.setTitle({title:"Google Tasks"}),chrome.browserAction.setBadgeText("0"===c?{text:"0"}:{text:""})):(chrome.browserAction.setBadgeText({text:""}),chrome.browserAction.setTitle({title:"Google Tasks"}))},d=function(){var a,b,c,d,e,f,g,h,i;c=localStorage.getItem("com.bit51.chrome.bettergoogletasks.last_notify")||0,c<(new Date).getTime()-432e5&&(e=localStorage.getItem("com.bit51.chrome.bettergoogletasks.notify")||TASKS_NOTIFY,localStorage.setItem("com.bit51.chrome.bettergoogletasks.last_notify",(new Date).getTime()),e>0&&(i=void 0,h=void 0,(j>0||k>0)&&(j>0&&k>0?(j>1?(b="Tasks",a="tasks"):(b="Task",a="task"),k>1?(g="Tasks",f="tasks"):(g="Task",f="task"),i="Overdue "+g+" and "+b+" Due Today",h="You have "+k+" overdue "+f+" & "+j+" "+a+" due today."):j>0?(j>1?(b="Tasks",a="tasks"):(b="Task",a="task"),i=b+" Due Today",h="You have "+j+" "+a+" due today."):(k>1?(g="Tasks",f="tasks"):(g="Task",f="task"),i="Overdue "+g,h="You have "+k+" overdue "+f+".")),d={type:"basic",title:i,message:h,iconUrl:"/images/icon.png"},chrome.notifications.create("BGT",d,function(){})))},l=function(){var a,b,c,d;return c=new Date,d=c.getYear(),b=c.getMonth()+1,a=c.getDate(),2e3>d&&(d+=1900),10>b&&(b="0"+b),10>a&&(a="0"+a),d.toString()+b.toString()+a.toString()},f=function(){var a;a=chrome.extension.getViews({type:"popup"}),a.length>0?window.setTimeout(function(){f()},5e3):n()},h=null,i=null,a=0,j=0,k=0,g=0}).call(this);